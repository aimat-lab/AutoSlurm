#!/bin/bash
#SBATCH --job-name={{ fillers.job_name | default('auto_slurm_job') }}
#SBATCH --ntasks=1
#SBATCH --cpus-per-task={{ fillers.cpus | default('1') }}
#SBATCH --mem={{ fillers.mem | default('4G') }}
#SBATCH --time={{ fillers.time | default('01:00:00') }}
#SBATCH --output=/dev/null
#SBATCH --error=/dev/null
{% if fillers.partition -%}
#SBATCH --partition={{ fillers.partition }}
{% endif -%}
{% if fillers.gres -%}
#SBATCH --gres={{ fillers.gres }}
{% endif -%}

# ==============================================================
# NOTE! This script was autogenerated by the auto_slurm package.
# ==============================================================

{% block before %}
# Additional steps before the commands
{% endblock -%}
source $HOME/.bashrc
export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
{% if fillers.conda_env %}
source activate {{ fillers.conda_env }}
{% endif %}
{% if fillers.venv %}
source "$(realpath {{ fillers.venv }})/bin/activate"
{% endif %}

# Custom commands
{% for command in commands %}
SLURM_SUBMIT_TASK_INDEX={{ loop.index0 }} {% if options.get("gpus_per_task", None) is not none %}CUDA_VISIBLE_DEVICES={{ loop.index0 }}{% endif %} {{ command }} &>> slurm-${SLURM_JOB_ID}{%- if commands|length > 1 %}-{{ loop.index0 }}{% endif -%}.out &
{%- endfor -%}

{%- block after %}
# Additional steps after the commands
{% endblock -%}

